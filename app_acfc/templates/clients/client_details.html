<!-- ====================================================================
     ACFC - Template "Détails Client"
     ====================================================================
     
     Interface de gestion des détails client avec design Bootstrap moderne.
     Affiche les informations complètes d'un client avec onglets organisés
     pour les différents types de données (contact, commandes, factures).
     
     Variables Jinja attendues :
     - client : Objet Client SQLAlchemy avec toutes les relations
        - part : Objet Particulier (si client est un particulier)
        - pro : Objet Professionnel (si client est un professionnel)
        - addresses : Liste des objets Adresse liés au client
        - phones : Liste des objets Telephone liés au client
        - mails : Liste des objets Mail liés au client
        - orders : Liste des objets Commande liés au client
        - bills : Liste des objets Facture liés au client
     - success_message (optionnel) : Message de succès à afficher
     - error_message (optionnel) : Message d'erreur à afficher
     - message (optionnel) : Message d'erreur à afficher
     
     Features :
     - Design responsive Bootstrap 5
     - Onglets pour organiser l'information par type
     - Modals pour créer téléphones, emails et adresses
     - Actions rapides et navigation intuitive
     
     CSS et JS externes :
     - CSS : statics/clients/css/clients.css
     - JS : statics/clients/js/clients.js
==================================================================== -->

<!-- CSS spécifique aux clients (si pas déjà inclus) -->
{% if not request.endpoint.startswith('static') %}
<link rel="stylesheet" href="{{ url_for('static', filename='clients/css/clients.css') }}">
{% endif %}
<!-- Champs cachés pour les identifiants -->
<input type="hidden" id="client-id" value="{{ client.id }}">
<input type="hidden" id="client-type" value="{{ client.type_client }}">
{% if part %}
<input type="hidden" id="part-id" value="{{ part.id }}">
{% endif %}
{% if pro %}
<input type="hidden" id="pro-id" value="{{ pro.id }}">
{% endif %}

<div class="container-fluid">
    <!-- En-tête avec informations principales du client -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <!-- Avatar placeholder -->
                        <div class="me-4">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white fw-bold client-avatar">
                                {% if client.type_client == 1 and part %}
                                    {{ part.prenom[0].upper() }}{{ part.nom[0].upper() }}
                                {% elif client.type_client == 2 and pro %}
                                    {{ pro.raison_sociale[0].upper() }}
                                {% else %}
                                    C
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Informations principales -->
                        <div class="flex-grow-1">
                            <h2 class="mb-1 text-dark">{{ nom_affichage }}</h2>
                            <p class="text-muted mb-2">
                                <i class="bi bi-hash me-1"></i>Client n°{{ client.id }}
                                {% if client.type_client == 1 %}
                                    <span class="badge bg-primary ms-2">Particulier</span>
                                {% else %}
                                    <span class="badge bg-primary ms-2">Professionnel</span>
                                {% endif %}
                            </p>
                            <div class="d-flex flex-wrap gap-2">
                                <!-- Badge statut client -->
                                {% if client.is_active %}
                                    <span class="badge bg-primary">
                                        <i class="bi bi-check-circle me-1"></i>Actif
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-x-circle me-1"></i>Inactif
                                    </span>
                                {% endif %}
                                
                                <!-- Badge création -->
                                <span class="badge bg-primary">
                                    <i class="bi bi-calendar me-1"></i>Créé le {{ client.created_at.strftime('%d/%m/%Y') }}
                                </span>
                                
                                <!-- Badge réduction -->
                                <span class="badge bg-warning">
                                    <i class="bi bi-percent me-1"></i>Réduction {{ "%.1f"|format(client.reduces * 100) }}%
                                </span>
                            </div>
                        </div>
                        
                        <!-- Actions rapides -->
                        <div class="text-end">
                            <nav aria-label="Actions du client">
                                <a href="{{ url_for(('clients', 'modifier-get') | jinja_page_title, id_client=client.id) }}" 
                                   class="btn btn-outline-secondary btn-sm me-2">
                                    <i class="bi bi-pencil me-1"></i>Modifier
                                </a>
                                <a href="{{ url_for(('clients', 'recherche') | jinja_page_title) }}" 
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-arrow-left me-1"></i>Retour à la recherche
                                </a>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages de succès et d'erreur -->
    {% if success_message %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>
                {{ success_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if error_message %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                {{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
    {% endif %}

    {% if message %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Navigation par onglets -->
    <div class="row">
        <div class="col-12">
            <div class="nav nav-tabs nav-fill mb-4" id="clientTabs" role="tablist">
                <div class="nav-item">
                    <!-- Erreur sur le Aria-selected du fait du jinja -->
                    <button class="nav-link {% if tab == 'infos' or tab is none %}active{% endif %}" id="infos-tab"
                            data-bs-toggle="tab" data-bs-target="#infos" type="button" role="tab"
                            aria-controls="infos" {% if tab == 'infos' or tab is none %} aria-selected="true"{% else %} aria-selected="false" {% endif %}>
                        <i class="bi bi-person me-2"></i>Informations
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-link {% if tab == 'phone' %}active{% endif %}" id="phones-tab"
                            data-bs-toggle="tab" data-bs-target="#phones" type="button" role="tab"
                            aria-controls="phones" {% if tab == 'phone' %} aria-selected="true"{% else %} aria-selected="false" {% endif %}>
                        <i class="bi bi-telephone me-2"></i>Téléphones
                        {% set principal_phones = phones|selectattr('is_principal')|list %}
                        {% if principal_phones %}
                            <i class="bi bi-check-circle-fill text-success ms-1"></i>
                        {% else %}
                            <i class="bi bi-exclamation-triangle-fill text-danger ms-1"></i>
                        {% endif %}
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-link {% if tab == 'mail' %}active{% endif %}" id="emails-tab" data-bs-toggle="tab" 
                            data-bs-target="#emails" type="button" role="tab" aria-controls="emails"
                            {% if tab == 'mail' %} aria-selected="true"{% else %} aria-selected="false" {% endif %}>
                        <i class="bi bi-envelope me-2"></i>Emails
                        {% set principal_emails = mails|selectattr('is_principal')|list %}
                        {% if principal_emails %}
                            <i class="bi bi-check-circle-fill text-success ms-1"></i>
                        {% else %}
                            <i class="bi bi-exclamation-triangle-fill text-danger ms-1"></i>
                        {% endif %}
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-link {% if tab == 'add' %}active{% endif %}" id="addresses-tab" data-bs-toggle="tab" 
                            data-bs-target="#addresses" type="button" role="tab" aria-controls="addresses"
                            {% if tab == 'add' %} aria-selected="true"{% else %} aria-selected="false" {% endif %}>
                        <i class="bi bi-geo-alt me-2"></i>Adresses
                        {% set principal_addresses = addresses|selectattr('is_principal')|list %}
                        {% if principal_addresses %}
                            <i class="bi bi-check-circle-fill text-success ms-1"></i>
                        {% else %}
                            <i class="bi bi-exclamation-triangle-fill text-danger ms-1"></i>
                        {% endif %}
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-link {% if tab == 'order' %}active{% endif %}" id="orders-tab" data-bs-toggle="tab" 
                            data-bs-target="#orders" type="button" role="tab" aria-controls="orders"
                            {% if tab == 'order' %} aria-selected="true"{% else %} aria-selected="false" {% endif %}>
                        <i class="bi bi-cart me-2"></i>Commandes
                        {% set commandes_en_cours = orders|selectattr('is_expedie', 'equalto', false)|selectattr('is_annulee', 'equalto', false)|list %}
                        {% set nb_en_cours = commandes_en_cours|length %}
                        {% if nb_en_cours > 0 %}
                            <span class="badge bg-warning text-dark ms-1">{{ nb_en_cours }} en cours</span>
                        {% endif %}
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-link {% if tab == 'bill' %}active{% endif %}" id="invoices-tab" data-bs-toggle="tab" 
                            data-bs-target="#invoices" type="button" role="tab" aria-controls="invoices"
                            {% if tab == 'bill' %} aria-selected="true"{% else %} aria-selected="false" {% endif %}>
                        <i class="bi bi-receipt me-2"></i>Factures
                        <span id="invoices-count" class="badge bg-primary ms-1">{{ bills|length }}</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenu des onglets -->
    <div class="tab-content" id="clientTabsContent">
        
        <!-- Onglet Informations -->
        <div class="tab-pane fade{% if tab == 'info' or tab is none %} show active{% endif %}" id="infos" role="tabpanel">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="card-title mb-0">
                                {% if client.type_client == 1 %}
                                    <i class="bi bi-person-lines-fill me-2 text-primary"></i>Informations particulier
                                {% else %}
                                    <i class="bi bi-building me-2 text-primary"></i>Informations professionnel
                                {% endif %}
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if client.type_client == 1 and part %}
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="prenom" class="form-label text-muted">Prénom</label>
                                        <p id="prenom" class="fw-semibold">{{ part.prenom }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="nom" class="form-label text-muted">Nom</label>
                                        <p id="nom" class="fw-semibold">{{ part.nom }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="date_naissance" class="form-label text-muted">Date de naissance</label>
                                        <p id="date_naissance" class="fw-semibold">{{ part.date_naissance.strftime('%d/%m/%Y') if part.date_naissance else '' }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="lieu_naissance" class="form-label text-muted">Lieu de naissance</label>
                                        <p id="lieu_naissance" class="fw-semibold">{{ part.lieu_naissance if part.lieu_naissance else '' }}</p>
                                    </div>
                                </div>
                            {% elif client.type_client == 2 and pro %}
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <label for="raison_sociale" class="form-label text-muted">Raison sociale</label>
                                        <p id="raison_sociale" class="fw-semibold">{{ pro.raison_sociale }}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="type_pro" class="form-label text-muted">Type</label>
                                        <p id="type_pro" class="fw-semibold">
                                            {% if pro.type_pro == 1 %}
                                                Entreprise
                                            {% elif pro.type_pro == 2 %}
                                                Association
                                            {% elif pro.type_pro == 3 %}
                                                Administration
                                            {% endif %}
                                        </p>
                                    </div>
                                    {% if pro.siren %}
                                    <div class="col-md-6">
                                        <label for="siren" class="form-label text-muted">SIREN</label>
                                        <p id="siren" class="fw-semibold">{{ pro.siren }}</p>
                                    </div>
                                    {% endif %}
                                    {% if pro.rna %}
                                    <div class="col-md-6">
                                        <label for="rna" class="form-label text-muted">RNA</label>
                                        <p id="rna" class="fw-semibold">{{ pro.rna }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    {% if client.notes %}
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-white border-bottom">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-sticky me-2 text-warning"></i>Notes
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">{{ client.notes }}</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-info-circle me-2 text-info"></i>Résumé du client
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-muted">Téléphones</span>
                                <span class="badge text-primary">
                                    {{ phones|selectattr('is_inactive', 'equalto', False)|list|length }}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-muted">Emails</span>
                                <span class="badge text-primary">
                                    {{ mails|selectattr('is_inactive', 'equalto', False)|list|length }}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-muted">Adresses</span>
                                <span class="badge text-primary">
                                    {{ addresses|selectattr('is_inactive', 'equalto', False)|list|length }}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-muted">Commandes</span>
                                <span class="badge {{ 'text-success' if orders|length > 0 else 'text-warning' }}">{{ orders|length }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-muted">Factures</span>
                                <span class="badge {{ 'text-success' if bills|length > 0 else 'text-warning' }}">{{ bills|length }}</span>
                            </div>
                            <hr class="my-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Réduction appliquée</span>
                                <span class="badge text-info">{{ "%.1f"|format(client.reduces * 100) }}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Téléphones -->
        <div class="tab-pane fade{% if tab == 'phone' %}show active{% endif %}" id="phones" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-telephone me-2 text-primary"></i>Numéros de téléphone
                    </h5>
                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addPhoneModal">
                        <i class="bi bi-plus me-1"></i>Ajouter
                    </button>
                </div>
                <div class="card-body">
                    {% if client.tels %}
                        <div class="row g-3">
                            {% for telephone in phones
                                | sort(attribute='id', reverse=False)
                                | sort(attribute='is_inactive', reverse=False) %}
                            <div class="col-md-6">
                                <div class="card border{% if telephone.is_principal %} principal-contact{% endif %}{% if telephone.is_inactive %} bg-light text-muted opacity-50{% endif %}">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="card-title mb-1">
                                                    <i class="bi bi-telephone me-1"></i>{{ telephone.type_telephone|title }}
                                                    {% if telephone.is_principal %}
                                                    <span class="badge badge-principal me-2">
                                                        <i class="bi bi-star-fill me-1"></i>Principal
                                                    </span>
                                                    {% endif %}
                                                </h6>
                                                <p class="card-text fw-bold mb-1">
                                                    {% if telephone.indicatif %}{{ telephone.indicatif }} {% endif %}{{ telephone.telephone }}
                                                </p>
                                                {% if telephone.detail %}
                                                <p class="card-text small text-muted mb-0">{{ telephone.detail }}</p>
                                                {% endif %}
                                                <p class="card-text small text-muted mb-0">
                                                    {% if telephone.is_inactive %}
                                                        <i class="bi bi-x-circle-fill me-1"></i>Inactif
                                                    {% else %}
                                                        <i class="bi bi-check-circle-fill me-1"></i>Actif
                                                    {% endif %}
                                                    {% if telephone.modified_by %}
                                                        <i class="bi bi-pencil me-1"></i>Modifié par {{ telephone.modified_by }} le {{ telephone.modified_at | date_input }}    
                                                    {% else %}
                                                        <i class="bi bi-person-fill me-1"></i>Créé par {{ telephone.created_by }} le {{ telephone.created_at | date_input }}
                                                    {% endif %}
                                                </p>
                                            </div>
                                            {% if not telephone.is_inactive %}
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-label="Options pour le téléphone">
                                                    <i class="bi bi-three-dots-vertical"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><button type="button" class="dropdown-item" 
                                                        data-phone-id="{{ telephone.id }}"
                                                        data-phone-telephone="{{ telephone.telephone }}"
                                                        data-phone-type="{{ telephone.type_telephone }}"
                                                        data-phone-indicatif="{{ telephone.indicatif or '' }}"
                                                        data-phone-detail="{{ telephone.detail or '' }}"
                                                        data-phone-principal="{{ telephone.is_principal|lower }}"
                                                        onclick="editPhone(this.dataset.phoneId, this)">
                                                        <i class="bi bi-pencil me-2"></i>Modifier
                                                    </button></li>
                                                    <li><button type="button" class="dropdown-item text-danger"
                                                                data-client-id="{{ client.id }}"
                                                                data-phone-id="{{ telephone.id }}"
                                                                onclick="deletePhoneWithConfirm(this)">
                                                        <i class="bi bi-trash me-2"></i>Supprimer
                                                    </button></li>
                                                </ul>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-telephone fs-3 text-muted mb-3"></i>
                            <p class="text-muted mb-3">Aucun numéro de téléphone enregistré</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPhoneModal">
                                <i class="bi bi-plus me-1"></i>Ajouter le premier numéro
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Onglet Emails -->
        <div class="tab-pane fade{% if tab == 'mail' %} show active{% endif %}" id="emails" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-envelope me-2 text-primary"></i>Adresses mail
                    </h5>
                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addEmailModal">
                        <i class="bi bi-plus me-1"></i>Ajouter
                    </button>
                </div>
                <div class="card-body">
                    {% if mails %}
                        <div class="row g-3">
                            {% for email in mails 
                                | sort(attribute='id', reverse=False)
                                | sort(attribute='is_inactive', reverse=False) %}
                            <div class="col-md-6">
                                <div class="card border{% if email.is_principal %} principal-contact{% endif %} {% if email.is_inactive %} bg-light text-muted opacity-50{% endif %}">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="card-title mb-1">
                                                    <i class="bi bi-envelope me-1"></i>{{ email.type_mail|title }}
                                                    {% if email.is_principal %}
                                                        <span class="badge badge-principal me-2">
                                                            <i class="bi bi-star-fill me-1"></i>Principal
                                                        </span>
                                                    {% endif %}
                                                </h6>
                                                <p class="card-text fw-bold mb-1">{{ email.mail }}</p>
                                                {% if email.detail %}
                                                <p class="card-text small text-muted mb-0">{{ email.detail }}</p>
                                                {% endif %}
                                                <p class="card-text small text-muted mb-0">
                                                    {% if email.is_inactive %}
                                                        <i class="bi bi-x-circle-fill me-1"></i>Inactif
                                                    {% else %}
                                                        <i class="bi bi-check-circle-fill me-1"></i>Actif
                                                    {% endif %}
                                                    {% if email.modified_by %}
                                                        <i class="bi bi-pencil me-1"></i>Modifié par {{ email.modified_by }} le {{ email.modified_at | date_input }}    
                                                    {% else %}
                                                        <i class="bi bi-person-fill me-1"></i>Créé par {{ email.created_by }} le {{ email.created_at | date_input }}
                                                    {% endif %}
                                                </p>
                                            </div>
                                            {% if not email.is_inactive %}
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-label="Actions pour l'email">
                                                    <i class="bi bi-three-dots-vertical"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><button class="dropdown-item" type="button" 
                                                        data-email-id="{{ email.id }}" 
                                                        data-email-mail="{{ email.mail }}"
                                                        data-email-type="{{ email.type_mail }}"
                                                        data-email-detail="{{ email.detail or '' }}"
                                                        data-email-principal="{{ email.is_principal|lower }}"
                                                        onclick="editEmail(this.dataset.emailId, this)">
                                                        <i class="bi bi-pencil me-2"></i>Modifier
                                                    </button></li>
                                                    <li><button class="dropdown-item text-danger" type="button" data-email-id="{{ email.id }}" onclick="deleteEmail(this.dataset.emailId)">
                                                        <i class="bi bi-trash me-2"></i>Supprimer
                                                    </button></li>
                                                </ul>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-envelope fs-3 text-muted mb-3"></i>
                            <p class="text-muted mb-3">Aucune adresse email enregistrée</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmailModal">
                                <i class="bi bi-plus me-1"></i>Ajouter la première adresse
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Onglet Adresses -->
        <div class="tab-pane fade{% if tab == 'add' %} show active{% endif %}" id="addresses" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-geo-alt me-2 text-primary"></i>Adresses
                    </h5>
                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                        <i class="bi bi-plus me-1"></i>Ajouter
                    </button>
                </div>
                <div class="card-body">
                    {% if addresses %}
                        <div class="row g-3">
                            {% for adresse in addresses
                                | sort(attribute='id', reverse=False)
                                | sort(attribute='is_inactive', reverse=False) %}
                            <div class="col-md-6">
                                <div class="card border{% if adresse.is_principal %} principal-contact{% endif %}{% if adresse.is_inactive %} bg-light text-muted opacity-50{% endif %}">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="card-title mb-2">
                                                    <i class="bi bi-house me-1"></i>Adresse {{ loop.index }}
                                                    {% if adresse.is_principal %}
                                                        <span class="badge badge-principal me-2">
                                                            <i class="bi bi-star-fill me-1"></i>Principal
                                                        </span>
                                                    {% endif %}
                                                </h6>
                                                <p class="card-text mb-1">{{ adresse.adresse_l1 }}</p>
                                                {% if adresse.adresse_l2 %}
                                                <p class="card-text mb-1">{{ adresse.adresse_l2 }}</p>
                                                {% endif %}
                                                <p class="card-text mb-0"><strong>{{ adresse.code_postal }} {{ adresse.ville }}</strong></p>
                                                {% if adresse.detail %}
                                                <p class="card-text small text-muted mb-0">{{ adresse.detail }}</p>
                                                {% endif %}
                                                <p class="card-text small text-muted mb-0">
                                                    {% if adresse.is_inactive %}
                                                    <p class="card-text small text-muted mb-0">
                                                        <i class="bi bi-x-circle-fill me-1"></i>Inactif
                                                    </p>
                                                    {% endif %}
                                                    {% if adresse.modified_by %}
                                                    <p class="card-text small text-muted mb-0">
                                                        <i class="bi bi-pencil me-1"></i>Modifiée par {{ adresse.modified_by }} le {{ adresse.modified_at | date_input }}    
                                                    </p>
                                                    {% else %}
                                                    <p class="card-text small text-muted mb-0">
                                                        <i class="bi bi-person-fill me-1"></i>Créée par {{ adresse.created_by }} le {{ adresse.created_at | date_input }}
                                                    </p>
                                                    {% endif %}
                                                </p>
                                            </div>
                                            {% if not adresse.is_inactive %}
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-label="Actions pour l'adresse">
                                                    <i class="bi bi-three-dots-vertical"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><button class="dropdown-item" type="button" 
                                                        data-address-id="{{ adresse.id }}"
                                                        data-address-l1="{{ adresse.adresse_l1 }}"
                                                        data-address-l2="{{ adresse.adresse_l2 or '' }}"
                                                        data-address-postal="{{ adresse.code_postal }}"
                                                        data-address-ville="{{ adresse.ville }}"
                                                        data-address-principal="{{ adresse.is_principal|lower }}"
                                                        onclick="editAddress(this.dataset.addressId, this)">
                                                        <i class="bi bi-pencil me-2"></i>Modifier
                                                    </button></li>
                                                    <li><button class="dropdown-item text-danger" type="button" data-address-id="{{ adresse.id }}" onclick="deleteAddress(this.dataset.addressId)">
                                                        <i class="bi bi-trash me-2"></i>Supprimer
                                                    </button></li>
                                                </ul>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-geo-alt fs-3 text-muted mb-3"></i>
                            <p class="text-muted mb-3">Aucune adresse enregistrée</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                                <i class="bi bi-plus me-1"></i>Ajouter la première adresse
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Onglet Commandes -->
        <div class="tab-pane fade{% if tab == 'order' %} show active{% endif %}" id="orders" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-cart me-2 text-primary"></i>Commandes
                    </h5>
                    <a href="{{ url_for(('commandes','nouvelle') | jinja_page_title, id_client=client.id) }}" class="btn btn-success btn-sm">
                        <i class="bi bi-plus me-1"></i>Nouvelle commande
                    </a>
                </div>
                <div class="card-body">
                    {% if orders %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>N° Commande</th>
                                        <th>Date</th>
                                        <th>Montant</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for commande in orders %}
                                    <tr {% if commande.is_annulee %}class="table-danger"{% endif %}>
                                        <td><strong>#{{ commande.id }}</strong></td>
                                        <td>{{ commande.date_commande.strftime('%d/%m/%Y') }}</td>
                                        <td><strong>{{ "%.2f"|format(commande.montant) }} €</strong></td>
                                        <td>
                                            {% if commande.is_annulee %}
                                                <span class="badge bg-danger">Annulée</span>
                                            {% elif commande.is_expedie %}
                                                <span class="badge bg-success">Expédiée</span>
                                            {% elif commande.is_facture %}
                                                <span class="badge bg-info">Facturée</span>
                                            {% else %}
                                                <span class="badge bg-warning">En cours</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <fieldset class="btn-group gap-1" role="group" aria-label="Actions commande">
                                                <a href="{{ url_for(('commandes', 'detail') | jinja_page_title, id_client=commande.id_client, id_commande=commande.id) }}" 
                                                   class="btn btn-sm btn-outline-primary" title="Voir les détails">
                                                    <i class="bi bi-eye me-1"></i>Voir
                                                </a>
                                                {% if not commande.is_annulee and not commande.is_facture %}
                                                <a href="{{ url_for(('commandes', 'modifier') | jinja_page_title, id_client=commande.id_client, id_commande=commande.id) }}" 
                                                   class="btn btn-sm btn-outline-secondary ms-1" title="Modifier la commande">
                                                    <i class="bi bi-pencil me-1"></i>Modifier
                                                </a>
                                                {% elif not commande.is_expedie and not commande.is_facture and not commande.is_annulee %}
                                                {% from '_macros.html' import csrf_field %}
                                                <form class="inline-display" method="POST" action="{{ url_for(('commandes', 'annuler') | jinja_page_title, id_client=commande.id_client, id_commande=commande.id) }}" 
                                                    onsubmit="return confirm('Êtes-vous sûr de vouloir annuler cette commande ?');">
                                                    {{ csrf_field() }}
                                                    <button type="submit" class="btn btn-sm btn-outline-danger ms-1" title="Annuler la commande">
                                                        <i class="bi bi-x-circle me-1"></i>Annuler
                                                    </button>
                                                </form>
                                                {% endif %}
                                                {% if commande.is_annulée %}
                                                    <span class="text-muted">
                                                        <i class="bi bi-x-circle me-1"></i>Commande annulée
                                                    </span>
                                                {% elif commande.is_facture %}
                                                    <span class="text-muted">
                                                        <i class="bi bi-check-circle me-1"></i>Commande facturée
                                                    </span>
                                                {% elif commande.is_expedie %}
                                                    <span class="text-muted">
                                                        <i class="bi bi-truck me-1"></i>Commande expédiée
                                                    </span>
                                                {% endif %}
                                            </fieldset>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-cart fs-3 text-muted mb-3"></i>
                            <p class="text-muted mb-3">Aucune commande enregistrée</p>
                            <a href="{{ url_for(('commandes', 'nouvelle') | jinja_page_title, id_client=client.id) }}" class="btn btn-primary">
                                <i class="bi bi-plus me-1"></i>Créer la première commande
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Onglet Factures -->
        <div class="tab-pane fade{% if tab == 'bill' %} show active{% endif %}" id="invoices" role="tabpanel">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-receipt me-2 text-primary"></i>Factures
                    </h5>
                </div>
                <div class="card-body">
                    {% if bills %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th class="hidden">N° Facture</th>
                                        <th>ID Fiscal</th>
                                        <th>Date</th>
                                        <th>Montant</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for facture in bills %}
                                    <tr>
                                        <td class="hidden"><strong>#{{ facture.id }}</strong></td>
                                        <td><code>{{ facture.id_fiscal }}</code></td>
                                        <td>{{ facture.date_facturation.strftime('%d/%m/%Y') }}</td>
                                        <td><strong>{{ "%.2f"|format(facture.montant_facture) }} €</strong></td>
                                        <td>
                                            {% if facture.is_imprime %}
                                                <span class="badge bg-success">Imprimée</span>
                                            {% else %}
                                                <span class="badge bg-warning">En attente</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ url_for(('commandes', 'detail') | jinja_page_title, id_facture=facture.id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye me-1"></i>Voir
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-receipt fs-3 text-muted mb-3"></i>
                            <p class="text-muted mb-3">Aucune facture émise</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajout/Modification Téléphone -->
<div class="modal fade" id="addPhoneModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-telephone me-2"></i>Ajouter un numéro de téléphone
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            {% from '_macros.html' import csrf_field %}
            <form action="{{ url_for(('clients', 'phone-add') | jinja_page_title, id_client=client.id) }}" method="post" id="addPhoneForm">
                {{ csrf_field() }}
                <div class="modal-body">
                    <input type="hidden" name="id_client" value="{{ client.id }}">
                    
                    <div class="mb-3">
                        <label for="type_telephone" class="form-label">Type de téléphone</label>
                        <select class="form-select" id="type_telephone" name="type_telephone" required>
                            <option value="">Choisir un type...</option>
                            <option value="fixe_pro">Fixe professionnel</option>
                            <option value="mobile_pro">Mobile professionnel</option>
                            <option value="fixe_perso">Fixe personnel</option>
                            <option value="mobile_perso">Mobile personnel</option>
                            <option value="fax">Fax</option>
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="indicatif" class="form-label">Indicatif</label>
                                <select type="text" class="form-control" id="indicatif" 
                                       name="indicatif" onfocus="updateIndic(this.value)" required>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telephone" class="form-label">Numéro</label>
                                <input type="text" class="form-control" id="telephone" 
                                       name="telephone" placeholder="0123456789" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="detail_phone" class="form-label">Détail (optionnel)</label>
                        <input type="text" class="form-control" id="detail_phone" 
                               name="detail" placeholder="Heures de contact, précisions...">
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is_principal_phone" 
                               name="is_principal" value="true">
                        <label class="form-check-label" for="is_principal_phone">
                            Téléphone principal
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg me-2"></i>Ajouter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ajout/Modification Email -->
<div class="modal fade" id="addEmailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-envelope me-2"></i>Ajouter une adresse email
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            {% from '_macros.html' import csrf_field %}
            <form action="{{ url_for(('clients', 'mail-add') | jinja_page_title, id_client=client.id) }}" method="post" id="addEmailForm">
                {{ csrf_field() }}
                <div class="modal-body">
                    <input type="hidden" name="id_client" value="{{ client.id }}">
                    
                    <div class="mb-3">
                        <label for="type_mail" class="form-label">Type d'email</label>
                        <select class="form-select" id="type_mail" name="type_mail" required>
                            <option value="">Choisir un type...</option>
                            <option value="professionnel">Professionnel</option>
                            <option value="personnel">Personnel</option>
                            <option value="facturation">Facturation</option>
                            <option value="marketing">Marketing</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mail" class="form-label">Adresse email</label>
                        <input type="email" class="form-control" id="mail" 
                               name="mail" placeholder="exemple@domaine.com" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="detail_mail" class="form-label">Détail (optionnel)</label>
                        <input type="text" class="form-control" id="detail_mail" 
                               name="detail" placeholder="Précisions sur l'usage...">
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is_principal_mail" 
                               name="is_principal" value="true">
                        <label class="form-check-label" for="is_principal_mail">
                            Email principal
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg me-2"></i>Ajouter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ajout/Modification Adresse -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-geo-alt me-2"></i>Ajouter une adresse
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            {% from '_macros.html' import csrf_field %}
            <form action="{{ url_for(('clients', 'address-add') | jinja_page_title, id_client=client.id) }}" method="post" id="addAddressForm">
                {{ csrf_field() }}
                <div class="modal-body">
                    <input type="hidden" name="id_client" value="{{ client.id }}">
                    
                    <div class="mb-3">
                        <label for="adresse_l1" class="form-label">Adresse ligne 1</label>
                        <input type="text" class="form-control" id="adresse_l1" 
                               name="adresse_l1" placeholder="Numéro et nom de rue" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="adresse_l2" class="form-label">Adresse ligne 2 (optionnel)</label>
                        <input type="text" class="form-control" id="adresse_l2" 
                               name="adresse_l2" placeholder="Complément d'adresse, bâtiment...">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="code_postal" class="form-label">Code postal</label>
                                <input type="text" class="form-control" id="code_postal" 
                                       name="code_postal" placeholder="75001" required>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="ville" class="form-label">Ville</label>
                                <input type="text" class="form-control" id="ville" 
                                       name="ville" placeholder="Paris" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="detail_address" class="form-label">Détail (optionnel)</label>
                                <input type="text" class="form-control" id="detail_address" 
                                name="detail" placeholder="Précisions sur l'adresse...">
                            </div>
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is_principal_adresse" 
                               name="is_principal" value="true">
                        <label class="form-check-label" for="is_principal_adresse">
                            Adresse principale
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg me-2"></i>Ajouter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript spécifique aux clients (si pas déjà inclus) -->
{% if not request.endpoint.startswith('static') %}
<script src="{{ url_for('static', filename='clients/js/clients.js') }}"></script>
{% endif %}
