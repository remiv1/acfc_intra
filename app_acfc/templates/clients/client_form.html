<!-- ====================================================================
     ACFC - Template "Formulaire Client"
     ====================================================================
     
     Formulaire de création et modification de clients avec design Bootstrap moderne.
     Support des clients particuliers et professionnels avec validation côté client.
     
     Variables Jinja attendues :
     - sub_context : 'create' ou 'edit'
     - client (optionnel) : Objet Client SQLAlchemy pour modification
     - error_message (optionnel) : Message d'erreur à afficher
     - success_message (optionnel) : Message de succès à afficher
     
     Features :
     - Formulaire dynamique selon le type de client
     - Validation HTML5 et JavaScript
     - Design responsive Bootstrap 5
     - Basculement automatique entre particulier/professionnel
==================================================================== -->

<!-- CSS spécifique aux clients -->
<link rel="stylesheet" href="{{ url_for('static', filename='clients/css/clients.css') }}">

<div class="container-fluid">
    <!-- En-tête du formulaire -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h2 class="mb-1 text-dark">
                                {% if sub_context == 'create' %}
                                    <i class="bi bi-person-plus me-2"></i>Nouveau Client
                                {% else %}
                                    <i class="bi bi-pencil me-2"></i>Modifier {% if nom_affichage %}{{ nom_affichage }}{% else %}Client{% endif %}
                                {% endif %}
                            </h2>
                            <p class="text-muted mb-0">
                                {% if sub_context == 'create' %}
                                    Créer une nouvelle fiche client
                                {% else %}
                                    Modification des informations client
                                {% endif %}
                            </p>
                        </div>
                        <div>
                            <a href="{{ url_for(('clients', 'recherche') | jinja_page_title) }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Retour à la recherche
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages d'erreur et de succès -->
    {% if error_message %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                {{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if success_message %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>
                {{ success_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Formulaire principal -->
    <div class="row">
        <div class="col-12">
            <form action="{% if sub_context == 'create' %}{{ url_for(('clients', 'creation') | jinja_page_title) }}{% else %}{{ url_for(('clients', 'modifier-post') | jinja_page_title, id_client=id_client) }}{% endif %}" 
                  method="post" class="needs-validation" novalidate id="clientForm">
                
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-info-circle me-2 text-primary"></i>Informations générales
                        </h5>
                    </div>
                    <div class="card-body">
                        
                        <!-- Sélection du type de client -->
                        {% if sub_context == 'create' %}
                        <div class="row mb-4">
                            <div class="col-12">
                                <label for="type_clt" class="form-label">Type de client <span class="text-danger">*</span></label>
                                <div id="type_clt" class="d-flex gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="type_client" 
                                               id="type_particulier" value="1" checked required>
                                        <label class="form-check-label" for="type_particulier">
                                            <i class="bi bi-person me-1"></i>Particulier
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="type_client" 
                                               id="type_professionnel" value="2" required>
                                        <label class="form-check-label" for="type_professionnel">
                                            <i class="bi bi-building me-1"></i>Professionnel
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Client existant - affichage du type -->
                        <input type="hidden" name="type_client" value="{{ client.type_client }}">
                        <div class="row mb-4">
                            <div class="col-12">
                                <label for="tpe_clt" class="form-label">Type de client</label>
                                <p id="type_clt" class="form-control-plaintext">
                                    {% if client.type_client == 1 %}
                                        <i class="bi bi-person me-1"></i>Particulier
                                    {% else %}
                                        <i class="bi bi-building me-1"></i>Professionnel
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Réduction appliquée -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="reduces" class="form-label">Réduction appliquée</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="reduces" name="reduces" 
                                           min="0" max="100" step="0.1" 
                                           value="{% if client %}{{ (client.reduces * 100)|round(1) }}{% else %}10.0{% endif %}"
                                           placeholder="10.0">
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="form-text">Réduction en pourcentage (ex: 10.0 = 10%)</div>
                            </div>
                        </div>
                        
                        <!-- Notes générales -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label for="notes" class="form-label">Notes (optionnel)</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3" 
                                          placeholder="Notes ou commentaires sur ce client...">{% if client and client.notes %}{{ client.notes }}{% endif %}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulaire spécifique Particulier -->
                <div class="card border-0 shadow-sm mt-4" id="form-particulier" 
                     {% if sub_context == 'edit' and client.type_client != 1 %}style="display: none;"{% endif %}>
                    <div class="card-header bg-white border-bottom">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-person-lines-fill me-2 text-success"></i>Informations particulier
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="prenom" class="form-label">Prénom <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="prenom" name="prenom" 
                                           value="{% if client and client.part and client.part.prenom %}{{ client.part.prenom }}{% endif %}" 
                                           placeholder="Prénom" required>
                                    <div class="invalid-feedback">Le prénom est obligatoire.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="nom" class="form-label">Nom <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="nom" name="nom" 
                                           value="{% if client and client.part and client.part.nom %}{{ client.part.nom }}{% endif %}" 
                                           placeholder="Nom de famille" required>
                                    <div class="invalid-feedback">Le nom est obligatoire.</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="date_naissance" class="form-label">Date de naissance</label>
                                    <input type="date" class="form-control" id="date_naissance" name="date_naissance" 
                                           value="{% if client and client.part and client.part.date_naissance %}{{ client.part.date_naissance }}{% endif %}" 
                                           >
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="lieu_naissance" class="form-label">Lieu de naissance</label>
                                    <input type="text" class="form-control" id="lieu_naissance" name="lieu_naissance" 
                                           value="{% if client and client.part and client.part.lieu_naissance %}{{ client.part.lieu_naissance }}{% endif %}" 
                                           placeholder="Ville de naissance">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulaire spécifique Professionnel -->
                <div class="card border-0 shadow-sm mt-4" id="form-professionnel" 
                     {% if sub_context == 'create' or (sub_context == 'edit' and client.type_client == 1) %}style="display: none;"{% endif %}>
                    <div class="card-header bg-white border-bottom">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-building me-2 text-primary"></i>Informations professionnel
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="raison_sociale" class="form-label">Raison sociale <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="raison_sociale" name="raison_sociale" 
                                           value="{% if client and client.pro and client.pro.raison_sociale %}{{ client.pro.raison_sociale }}{% endif %}" 
                                           placeholder="Nom de l'entreprise ou organisation" required>
                                    <div class="invalid-feedback">La raison sociale est obligatoire.</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="type_pro" class="form-label">Type <span class="text-danger">*</span></label>
                                    <select class="form-select" id="type_pro" name="type_pro" required>
                                        <option value="">Choisir...</option>
                                        <option value="1" {% if client and client.pro and client.pro.type_pro == 1 %}selected{% endif %}>Entreprise</option>
                                        <option value="2" {% if client and client.pro and client.pro.type_pro == 2 %}selected{% endif %}>Association</option>
                                        <option value="3" {% if client and client.pro and client.pro.type_pro == 3 %}selected{% endif %}>Administration</option>
                                    </select>
                                    <div class="invalid-feedback">Le type d'organisation est obligatoire.</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="siren" class="form-label">SIREN</label>
                                    <input type="text" class="form-control" id="siren" name="siren" 
                                           value="{% if client and client.pro and client.pro.siren %}{{ client.pro.siren }}{% endif %}" 
                                           placeholder="123456789" maxlength="9" pattern="[0-9]{9}">
                                    <div class="form-text">9 chiffres (obligatoire pour les entreprises)</div>
                                    <div class="invalid-feedback">Le SIREN doit contenir exactement 9 chiffres.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="rna" class="form-label">RNA</label>
                                    <input type="text" class="form-control" id="rna" name="rna" 
                                           value="{% if client and client.pro and client.pro.rna %}{{ client.pro.rna }}{% endif %}" 
                                           placeholder="W123456789" maxlength="10" pattern="W[0-9]{9}">
                                    <div class="form-text">Numéro RNA pour les associations (W + 9 chiffres)</div>
                                    <div class="invalid-feedback">Le RNA doit commencer par W suivi de 9 chiffres.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <a href="{{ url_for(('clients', 'recherche') | jinja_page_title) }}" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-left me-1"></i>Annuler
                                    </a>
                                    <button type="submit" class="btn btn-success">
                                        {% if sub_context == 'create' %}
                                            <i class="bi bi-check-lg me-1"></i>Créer le client
                                        {% else %}
                                            <i class="bi bi-save me-1"></i>Enregistrer les modifications
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript spécifique aux clients -->
<script src="{{ url_for('static', filename='clients/js/clients.js') }}"></script>

<!-- JavaScript spécifique au formulaire client -->
<script src="{{ url_for('static', filename='clients/js/client_form.js') }}"></script>
