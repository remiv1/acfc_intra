<!--
============================================================
    TEMPLATE POUR LA FACTURE √Ä IMPRIMER
============================================================
    Variables attendues :
    - bill : Objet facture avec les d√©tails de la facture
    - qr_code_base64 : Code QR en base64 pour le num√©ro de facture (sera remplac√© par le lien de r√®glement)
    - now : Date et heure actuelles pour le pied de page
-->

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facture #{{ facture.id_fiscal }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='commandes/css/facture_impression.css') }}">
</head>
<body>
    {% set two_adresses = bill.commande.is_ad_livraison %}
    <div class="facture-container">
        
        <!-- En-t√™te de la facture (2/5 de la hauteur) -->
        <div class="header-section">
            <div class="company-info">
                <div class="company-logo">
                    <img src="{{ url_for('static', filename='common/img/Logo.svg') }}" alt="Logo ACFC" class="img-fluid">
                </div>
                <div class="company-text">
                    <div class="company-name">Au Collectionneur Franc-Comtois</div>
                    <div class="company-details">
                        <strong>180 rue des glaciers</strong><br>
                        39190 Cousance<br>
                        T√©l. 03 84 24 56 12<br>
                        <small>RCS Lons le Saunier 524 176 30 00023</small>
                    </div>
                </div>
            </div>
            
            <div class="facture-title">
                FACTURE<br>
                <strong>{{ order.date_facturation|strftime }}</strong>
            </div>
            
            <!-- Adresses de facturation et livraison -->
            <div class="address-block">
                <div class="address-sections">
                    <div class="address-facturation">
                        <div class="address-label">
                            {% if two_adresses %}
                                Factur√© √† :
                            {% else %}
                                Factur√© et livr√© √† :
                            {% endif %}
                        </div>
                        <div class="client-name">{{ bill.order.client.nom_affichage }}</div>
                        {% if not two_adresses %}
                            {% set adresse_facturation = bill.order.adresse_facturation %}
                            <div class="client-address">
                                {{ adresse_facturation.adresse_l1 }}<br>
                                {% if adresse_facturation.adresse_l2 %}{{ adresse_facturation.adresse_l2 }}<br>{% endif %}
                                {{ adresse_facturation.code_postal }} {{ adresse_facturation.ville }}<br>
                                {% if adresse_facturation.pays and adresse_facturation.pays != 'FRANCE' %}{{ adresse_facturation.pays }}{% endif %}
                            </div>
                        {% endif %}
                        {% if bill.order.client.pro.siren or bill.order.client.pro.rna %}
                            <div class="small-text mt-1">
                                {% if bill.order.client.pro.siren %}SIREN : {{ bill.order.client.pro.siren }}
                                {% elif bill.order.client.pro.rna %}RNA : {{ bill.order.client.pro.rna }}{% endif %}
                            </div>
                        {% endif %}
                    </div>
                    {% if two_adresses %}
                    <div class="address-livraison">
                        <div class="address-label">Livr√© √† :</div>
                        <div class="client-name">{{ facture.client.nom_affichage }}</div>
                        {% if bill.order.adresse_livraison %}
                            {% set adresse_livraison = bill.order.adresse_livraison %}
                            <div class="client-address">
                                {{ adresse_livraison.adresse_l1 }}<br>
                                {% if adresse_livraison.adresse_l2 %}{{ adresse_livraison.adresse_l2 }}<br>{% endif %}
                                {{ adresse_livraison.code_postal }} {{ adresse_livraison.ville }}<br>
                                {% if adresse_livraison.pays and adresse_livraison.pays != 'FRANCE' %}{{ adresse_livraison.pays }}{% endif %}
                            </div>
                        {% else %}
                            <div class="client-address">M√™me adresse que facturation</div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Contenu principal de la facture -->
        <div class="content-section">
            <!-- Informations de la facture -->
            <div class="info-row">
                <div class="row">
                    <div class="col-md-12">
                        <div class="numero-facture mb-2">
                            N¬∞ de facture : <strong>{{ bill.id_fiscal }}</strong>
                        </div>
                        <div class="numero-commande">
                            <small>
                                N¬∞ de commande : <strong>{{ bill.id_order }}</strong>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tableau des articles -->
            <div class="table-container">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th id="th_reference">R√©f.</th>
                            <th id="th_designation">D√©signation</th>
                            <th id="th_qte" class="text-center">Qt√©</th>
                            <th id="th_pu" class="text-end">P.U.</th>
                            <th id="th_remise" class="text-center">
                                Remise
                                {% set economie_totale = 0 %}
                                {% for entry in bill.commande.devises %}
                                    {% if entry.remise > 0 %}
                                        {% set economie_totale = economie_totale + (entry.prix_unitaire * entry.qte * entry.remise) %}
                                    {% endif %}
                                {% endfor %}
                                {% if economie_totale > 0 %}
                                    <br><em class="text-success">(√âconomies r√©alis√©es : {{ "%.2f"|format(economie_totale) }}‚Ç¨)</em>
                                {% endif %}
                            </th>
                            <th id="th_total" class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set billed_entries = bill.commande.devises | selectattr('is_facture', 'equalto', True) | list %}
                        {% for entry in billed_entries %}
                        <tr>
                            <td><code class="text-primary">{{ entry.reference }}</code></td>
                            <td>{{ entry.designation }}</td>
                            <td class="text-center">{{ entry.qte }}</td>
                            <td class="text-end">{{ "%.2f"|format(entry.prix_unitaire) }} ‚Ç¨</td>
                            <td class="text-center">
                                {% if entry.remise > 0 %}
                                    <span class="badge bg-warning">{{ "%.0f"|format(entry.remise * 100) }}%</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="text-end"><strong>{{ "%.2f"|format(entry.qte * entry.prix_unitaire * (1 - entry.remise)) }} ‚Ç¨</strong></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Section totaux avec √©conomie -->
            <div class="total-section">
                <div class="total-with-economy">
                    <div>
                        <div class="small-text mb-2"><strong>Mentions l√©gales :</strong></div>
                        <div class="small-text">TVA : Non Soumis √† TVA, Article 261C-3¬∞ du Code G√©n√©ral des Imp√¥ts.</div>
                        <div class="small-text">{{ billed_entries|length }} article{{ 's' if billed_entries|length > 1 else '' }}</div>
                    </div>
                    <div class="text-end">
                        <h5 class="mb-2">Total √† payer</h5>
                        <h3 class="montant-highlight mb-0">{{ "%.2f"|format(bill.montant_facture) }} ‚Ç¨ TTC</h3>
                        <div class="economy-info mt-2">
                            üí∞ √âconomie client :
                            {{ "%.2f"|format(billed_entries|map(attribute='remise_euro')|sum) }} ‚Ç¨
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer avec bordereau et QR code -->
        <div class="footer-section">
            <div class="payment-section">
                <div class="bordereau-content">
                    <h6 class="mb-2">Bordereau de paiement (ch√®que - virement)</h6>
                    <div class="bordereau-style">
                        <div><strong>√Ä libeller √† l'ordre de :</strong> Au Collectionneur Franc-Comtois</div>
                        <small><strong>Chez :</strong> Madame Marie-Madeleine Verschuur</small>
                        <small><strong>Adresse :</strong> 6 rue du jeu de quilles, 39270 Chav√©ria</small>
                        <small><strong>N¬∞ facture :</strong> {{ bill.id_fiscal }} ‚Äî <strong>Montant :</strong> {{ "%.2f"|format(bill.montant_facture) }} ‚Ç¨</small>
                        <small><strong>IBAN :</strong> FR76 1250 6390 0356 0382 3694 715</small>
                        <small><strong>BIC :</strong> AGRIFRPP825</small>
                        <small><strong>Titulaire :</strong> Au Collectionneur Franc-Comtois</small>
                    </div>
                </div>
                <div class="qr-section">
                    {% if qr_code_base64 %}
                        <img src="data:image/png;base64,{{ qr_code_base64 }}" alt="QR Code" width="80" height="80">
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='commandes/js/bill-print.js') }}"></script>
    <script>
        // Si des initialisations sp√©cifiques sont n√©cessaires pour l'impression
        if (typeof initializeBonImpressionFeatures === 'function') { initializeBonImpressionFeatures(); }
    </script>
</body>
</html>
