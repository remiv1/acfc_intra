{% extends "base.html" %}

{% block title %}
    {% if sub_context == 'create' %}
        Nouvelle Commande - {{ client.nom_affichage }}
    {% else %}
        Modifier Commande #{{ commande.id }}
    {% endif %}
{% endblock %}

{% block head %}
<!-- CSS spécifique aux commandes -->
<link rel="stylesheet" href="{{ url_for('static', filename='commandes/css/commandes.css') }}">
{% endblock %}

{% block main %}
<div class="container-fluid">
    <!-- En-tête du formulaire -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h2 class="mb-1 text-dark">
                                {% if sub_context == 'create' %}
                                    <i class="fas fa-shopping-cart me-2"></i>Nouvelle Commande
                                {% else %}
                                    <i class="fas fa-edit me-2"></i>Modifier Commande #{{ commande.id }}
                                {% endif %}
                            </h2>
                            <p class="text-muted mb-0">
                                {% if sub_context == 'create' %}
                                    Créer une nouvelle commande pour {{ client.nom_affichage }}
                                {% else %}
                                    Modification de la commande du {{ commande.date_commande.strftime('%d/%m/%Y') }}
                                {% endif %}
                            </p>
                        </div>
                        <div>
                            <a href="{{ url_for('clients.client_details', id=client.id) }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Retour au client
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages d'erreur et de succès -->
    {% if error_message %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>
    {% endif %}

    {% if success_message %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>{{ success_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Formulaire principal -->
    <form method="POST" id="commandeForm">
        <div class="row">
            <!-- Informations de la commande -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations de la commande</h5>
                    </div>
                    <div class="card-body">
                        <!-- Client (affiché en lecture seule) -->
                        <input type="hidden" name="id_client" value="{{ client.id }}">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Client</label>
                            <div class="form-control-plaintext border p-2 bg-light">
                                <strong>{{ client.nom_affichage }}</strong>
                                {% if client.adresses %}
                                    <br><small class="text-muted">{{ client.adresses[0].ville }}</small>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Date de commande -->
                        <div class="mb-3">
                            <label for="date_commande" class="form-label fw-bold">Date de commande *</label>
                            <input type="date" class="form-control" id="date_commande" name="date_commande" 
                                   value="{% if commande %}{{ commande.date_commande.strftime('%Y-%m-%d') }}{% else %}{{ today.strftime('%Y-%m-%d') }}{% endif %}" required>
                        </div>

                        <!-- Descriptif -->
                        <div class="mb-3">
                            <label for="descriptif" class="form-label fw-bold">Descriptif</label>
                            <textarea class="form-control" id="descriptif" name="descriptif" rows="3" 
                                      placeholder="Description libre de la commande...">{% if commande %}{{ commande.descriptif }}{% endif %}</textarea>
                        </div>

                        <!-- Adresse de livraison -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Adresse de livraison</label>
                            {% if client.adresses %}
                                {% for adresse in client.adresses %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="id_adresse" id="adresse_{{ adresse.id }}" 
                                           value="{{ adresse.id }}" {% if loop.first and not commande %}checked{% elif commande and commande.id_adresse == adresse.id %}checked{% endif %}>
                                    <label class="form-check-label" for="adresse_{{ adresse.id }}">
                                        <strong>{{ adresse.designation or 'Adresse principale' }}</strong><br>
                                        {{ adresse.voie }}<br>
                                        {{ adresse.cp }} {{ adresse.ville }}
                                    </label>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-muted">Aucune adresse renseignée pour ce client</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- État de la commande -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>État de la commande</h5>
                    </div>
                    <div class="card-body">
                        <!-- Montant total (calculé automatiquement) -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Montant total</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="montant" name="montant" 
                                       value="{% if commande %}{{ commande.montant }}{% else %}0.00{% endif %}" 
                                       step="0.01" readonly>
                                <span class="input-group-text">€</span>
                            </div>
                            <small class="text-muted">Calculé automatiquement selon les produits sélectionnés</small>
                        </div>

                        <!-- Statut facturation -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_facture" name="is_facture" 
                                       {% if commande and commande.is_facture %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="is_facture">
                                    Commande facturée
                                </label>
                            </div>
                        </div>

                        <!-- Date de facturation -->
                        <div class="mb-3" id="date_facturation_group" style="{% if not commande or not commande.is_facture %}display: none;{% endif %}">
                            <label for="date_facturation" class="form-label fw-bold">Date de facturation</label>
                            <input type="date" class="form-control" id="date_facturation" name="date_facturation" 
                                   value="{% if commande and commande.date_facturation %}{{ commande.date_facturation.strftime('%Y-%m-%d') }}{% endif %}">
                        </div>

                        <!-- Statut expédition -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_expedie" name="is_expedie" 
                                       {% if commande and commande.is_expedie %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="is_expedie">
                                    Commande expédiée
                                </label>
                            </div>
                        </div>

                        <!-- Date d'expédition -->
                        <div class="mb-3" id="date_expedition_group" style="{% if not commande or not commande.is_expedie %}display: none;{% endif %}">
                            <label for="date_expedition" class="form-label fw-bold">Date d'expédition</label>
                            <input type="date" class="form-control" id="date_expedition" name="date_expedition" 
                                   value="{% if commande and commande.date_expedition %}{{ commande.date_expedition.strftime('%Y-%m-%d') }}{% endif %}">
                        </div>

                        <!-- ID de suivi -->
                        <div class="mb-3" id="id_suivi_group" style="{% if not commande or not commande.is_expedie %}display: none;{% endif %}">
                            <label for="id_suivi" class="form-label fw-bold">Numéro de suivi</label>
                            <input type="text" class="form-control" id="id_suivi" name="id_suivi" 
                                   value="{% if commande %}{{ commande.id_suivi }}{% endif %}" 
                                   placeholder="Numéro de suivi de l'expédition">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sélection des produits du catalogue -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Sélection des produits</h5>
                    </div>
                    <div class="card-body">
                        <!-- Filtres pour le catalogue -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label for="filter_millesime" class="form-label fw-bold">Millésime</label>
                                <select class="form-select" id="filter_millesime" name="filter_millesime" onchange="this.form.submit()">
                                    <option value="">Tous les millésimes</option>
                                    {% for millesime in millesimes %}
                                    <option value="{{ millesime }}" {% if selected_filters.millesime == millesime %}selected{% endif %}>{{ millesime }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filter_type_produit" class="form-label fw-bold">Type de produit</label>
                                <select class="form-select" id="filter_type_produit" name="filter_type_produit" onchange="this.form.submit()">
                                    <option value="">Tous les types</option>
                                    {% for type_produit in types_produit %}
                                    <option value="{{ type_produit }}" {% if selected_filters.type_produit == type_produit %}selected{% endif %}>{{ type_produit }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filter_geographie" class="form-label fw-bold">Géographie</label>
                                <select class="form-select" id="filter_geographie" name="filter_geographie" onchange="this.form.submit()">
                                    <option value="">Toutes les géographies</option>
                                    {% for geographie in geographies %}
                                    <option value="{{ geographie }}" {% if selected_filters.geographie == geographie %}selected{% endif %}>{{ geographie }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="submit" name="action" value="clear_filters" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>Effacer les filtres
                                </button>
                            </div>
                        </div>

                        <!-- Tableau des produits du catalogue -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th width="50">Sélection</th>
                                        <th>Référence</th>
                                        <th>Désignation</th>
                                        <th>Type</th>
                                        <th>Millésime</th>
                                        <th>Géographie</th>
                                        <th>Prix HT</th>
                                        <th>Quantité</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for produit in catalogue_filtered %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" class="form-check-input product-checkbox" 
                                                   name="produits_selectionnes" value="{{ produit.id }}"
                                                   {% if produit.id in produits_commande_ids %}checked{% endif %}>
                                        </td>
                                        <td>{{ produit.ref_auto }}</td>
                                        <td>{{ produit.des_auto }}</td>
                                        <td>{{ produit.type_produit }}</td>
                                        <td>{{ produit.millesime }}</td>
                                        <td>{{ produit.geographie }}</td>
                                        <td>{{ "%.2f"|format(produit.prix_unitaire_ht) }} €</td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm quantity-input" 
                                                   name="qte_{{ produit.id }}" 
                                                   value="{% if produit.id in produits_commande %}{{ produits_commande[produit.id].qte }}{% else %}1{% endif %}" 
                                                   min="1" style="width: 80px;"
                                                   {% if produit.id not in produits_commande_ids %}disabled{% endif %}>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {% if not catalogue_filtered %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <p>Aucun produit trouvé avec les filtres sélectionnés.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Boutons d'action -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('clients.client_details', id=client.id) }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Annuler
                    </a>
                    <button type="submit" name="action" value="save" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>
                        {% if sub_context == 'create' %}Créer la commande{% else %}Mettre à jour{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- JavaScript spécifique au formulaire de commande -->
<script src="{{ url_for('static', filename='commandes/js/commande_form.js') }}"></script>
{% endblock %}
