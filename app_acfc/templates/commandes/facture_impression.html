<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facture #{{ facture.id_fiscal }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='commandes/css/facture_impression.css') }}">
</head>
<body>
    <div class="facture-container">
        
        <!-- En-tÃªte de la facture (2/5 de la hauteur) -->
        <div class="header-section">
            <div class="company-info">
                <div class="company-logo">
                    <img src="{{ url_for('static', filename='common/img/Logo.svg') }}" alt="Logo ACFC" class="img-fluid">
                </div>
                <div class="company-text">
                    <div class="company-name">Au Collectionneur Franc-Comtois</div>
                    <div class="company-details">
                        <strong>180 rue des glaciers</strong><br>
                        39190 Cousance<br>
                        TÃ©l. 03 84 24 56 12<br>
                        <small>RCS Lons le Saunier 524 176 30 00023</small>
                    </div>
                </div>
            </div>
            
            <div class="facture-title">
                FACTURE<br>
                <strong>{{ facture.date_facturation|strftime }}</strong>
            </div>
            
            <!-- Adresses de facturation et livraison -->
            <div class="address-block">
                <div class="address-sections">
                    <div class="address-facturation">
                        <div class="address-label">
                            {% if two_adresses %}
                                FacturÃ© Ã  :
                            {% else %}
                                FacturÃ© et livrÃ© Ã  :
                            {% endif %}
                        </div>
                        <div class="client-name">{{ facture.client.nom_affichage }}</div>
                        {% if facture.client.adresses %}
                            {% set adresse = facture.client.adresses[0] %}
                            <div class="client-address">
                                {{ adresse.adresse_l1 }}<br>
                                {% if adresse.adresse_l2 %}{{ adresse.adresse_l2 }}<br>{% endif %}
                                {{ adresse.code_postal }} {{ adresse.ville }}<br>
                                {% if adresse.pays and adresse.pays != 'FRANCE' %}{{ adresse.pays }}{% endif %}
                            </div>
                        {% endif %}
                        {% if facture.client.siren or facture.client.rna %}
                            <div class="small-text mt-1">
                                {% if facture.client.siren %}SIREN : {{ facture.client.siren }}
                                {% elif facture.client.rna %}RNA : {{ facture.client.rna }}{% endif %}
                            </div>
                        {% endif %}
                    </div>
                    {% if two_adresses %}
                    <div class="address-livraison">
                        <div class="address-label">LivrÃ© Ã  :</div>
                        <div class="client-name">{{ facture.client.nom_affichage }}</div>
                        {% if facture.client.adresses and facture.client.adresses|length > 1 %}
                            {% set adresse_livraison = facture.client.adresses[1] %}
                            <div class="client-address">
                                {{ adresse_livraison.voie }}<br>
                                {% if adresse_livraison.complement %}{{ adresse_livraison.complement }}<br>{% endif %}
                                {{ adresse_livraison.cp }} {{ adresse_livraison.ville }}<br>
                                {% if adresse_livraison.pays and adresse_livraison.pays != 'FRANCE' %}{{ adresse_livraison.pays }}{% endif %}
                            </div>
                        {% else %}
                            <div class="client-address">MÃªme adresse que facturation</div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Contenu principal de la facture -->
        <div class="content-section">
            <!-- Informations de la facture -->
            <div class="info-row">
                <div class="row">
                    <div class="col-md-12">
                        <div class="numero-facture mb-2">NÂ° de facture : <strong>{{ facture.id_fiscal }}</strong></div>
                        <div class="numero-commande">NÂ° de commande : <strong>{{ facture.id_commande }}</strong></div>
                    </div>
                </div>
            </div>

            <!-- Tableau des articles -->
            <div class="table-container">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th id="th_reference">RÃ©f.</th>
                            <th id="th_designation">DÃ©signation</th>
                            <th id="th_qte" class="text-center">QtÃ©</th>
                            <th id="th_pu" class="text-end">P.U.</th>
                            <th id="th_remise" class="text-center">
                                Remise
                                {% set economie_totale = 0 %}
                                {% for ligne in lignes_facturees %}
                                    {% if ligne.remise > 0 %}
                                        {% set economie_totale = economie_totale + (ligne.prix_unitaire * ligne.qte * ligne.remise) %}
                                    {% endif %}
                                {% endfor %}
                                {% if economie_totale > 0 %}
                                    <br><small class="text-success">(Ã‰conomies : {{ "%.2f"|format(economie_totale) }}â‚¬)</small>
                                {% endif %}
                            </th>
                            <th id="th_total" class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ligne in lignes_facturees %}
                        <tr>
                            <td><code class="text-primary">{{ ligne.reference }}</code></td>
                            <td>{{ ligne.designation }}</td>
                            <td class="text-center">{{ ligne.qte }}</td>
                            <td class="text-end">{{ "%.2f"|format(ligne.prix_unitaire) }} â‚¬</td>
                            <td class="text-center">
                                {% if ligne.remise > 0 %}
                                    <span class="badge bg-warning">{{ "%.0f"|format(ligne.remise * 100) }}%</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="text-end"><strong>{{ "%.2f"|format(ligne.qte * ligne.prix_unitaire * (1 - ligne.remise)) }} â‚¬</strong></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Section totaux avec Ã©conomie -->
            <div class="total-section">
                <div class="total-with-economy">
                    <div>
                        <div class="small-text mb-2"><strong>Mentions lÃ©gales :</strong></div>
                        <div class="small-text">TVA : Non Soumis Ã  TVA, Article 261C-3Â° du Code GÃ©nÃ©ral des ImpÃ´ts.</div>
                        <div class="small-text">{{ lignes_facturees|length }} article{{ 's' if lignes_facturees|length > 1 else '' }}</div>
                    </div>
                    <div class="text-end">
                        <h5 class="mb-2">Total Ã  payer</h5>
                        <h3 class="montant-highlight mb-0">{{ "%.2f"|format(facture.montant_facture) }} â‚¬ TTC</h3>
                        <div class="economy-info mt-2">
                            ðŸ’° Ã‰conomie client : 
                            {{ "%.2f"|format(lignes_facturees|map(attribute='remise_euro')|sum) }} â‚¬
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer avec bordereau et QR code -->
        <div class="footer-section">
            <div class="payment-section">
                <div class="bordereau-content">
                    <h6 class="mb-2">Bordereau de paiement (chÃ¨que)</h6>
                    <div class="bordereau-style">
                        <div><strong>Ã€ libeller Ã  l'ordre de :</strong> Au Collectionneur Franc-Comtois</div>
                        <div><strong>Adresse :</strong> 180 rue des glaciers, 39190 Cousance</div>
                        <div><strong>NÂ° facture :</strong> {{ facture.id_fiscal }} â€” <strong>Montant :</strong> {{ "%.2f"|format(facture.montant_facture) }} â‚¬</div>
                    </div>
                </div>
                <div class="qr-section">
                    {% if qr_code_base64 %}
                        <img src="data:image/png;base64,{{ qr_code_base64 }}" alt="QR Code" width="80" height="80">
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='commandes/js/commande_details.js') }}"></script>
    <script>
        // Si des initialisations spÃ©cifiques sont nÃ©cessaires pour l'impression
        if (typeof initializeBonImpressionFeatures === 'function') { initializeBonImpressionFeatures(); }
    </script>
</body>
</html>
