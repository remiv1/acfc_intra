<!-- ====================================================================
    ACFC - Template "Formulaire Commande" (Contenu)
    ====================================================================
     
    Contenu du formulaire de création/modification de commande.
    Inclus dans le template principal des commandes via le système de contextes.
     
    Variables Jinja attendues :
    - client : Objet Client SQLAlchemy (client concerné)
    - commande : Objet Commande SQLAlchemy (None si création)
    - form_sub_context : 'create' ou 'edit' (contexte du formulaire)
    - catalogue_complet : Liste complète des produits du catalogue (pour la modale)
    - millesimes : Liste des millésimes disponibles (pour filtres)
    - types_produit : Liste des types de produit (pour filtres)
    - geographies : Liste des géographies (pour filtres)
    - error_message : Message d'erreur éventuel à afficher
    - success_message : Message de succès éventuel à afficher
    - lignes_devis : Liste des lignes de produits de la commande (pour édition)
    - current_year : Année courante (pour sélection par défaut)
    - today : Date du jour pour le formulaire
==================================================================== -->

<!-- CSS spécifique aux commandes -->
<link rel="stylesheet" href="{{ url_for('static', filename='commandes/css/commandes.css') }}">

<div class="container-fluid">
    <!-- En-tête du formulaire -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h2 class="mb-1 text-dark">
                                {% if form_sub_context == 'create' %}
                                    <i class="fas fa-shopping-cart me-2"></i>Nouvelle Commande
                                {% else %}
                                    <i class="fas fa-edit me-2"></i>Modifier Commande #{{ commande.id }}
                                {% endif %}
                            </h2>
                            <p class="text-muted mb-0">
                                {% if form_sub_context == 'create' %}
                                    Créer une nouvelle commande pour {{ client.nom_affichage }}
                                {% else %}
                                    Modification de la commande du {{ commande.date_commande|strftime }}
                                {% endif %}
                            </p>
                        </div>
                        <div class="d-flex gap-2">
                            {% if form_sub_context == 'edit' %}
                                <a href="{{ url_for('commandes.commande_details', id_client=client.id, id_commande=commande.id) }}" class="btn btn-outline-info">
                                    <i class="fas fa-eye me-1"></i>Voir détails
                                </a>
                            {% endif %}
                            <a href="{{ url_for('clients.get_client', id_client=client.id) }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Retour au client
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages normaux, d'erreur et de succès -->
    {% if message %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
    {% endif %}

    {% if error_message %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert">X</button>
            </div>
        </div>
    </div>
    {% endif %}

    {% if success_message %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>{{ success_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert">X</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Formulaire principal -->
    {% from '_macros.html' import csrf_field %}    
    <form method="POST" id="commandeForm" action="{% if form_sub_context == 'create' %}{{ url_for('commandes.nouvelle_commande', id_client=client.id) }}{% else %}{{ url_for('commandes.commande_modify', id_client=client.id, id_commande=commande.id) }}{% endif %}">
        {{ csrf_field() }}
        <div class="row">
            <!-- Informations de la commande -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations de la commande</h5>
                    </div>
                    <div class="card-body">
                        <!-- Client (affiché en lecture seule) -->
                        <input id="id_client" type="hidden" name="id_client" value="{{ client.id }}">
                        <div class="mb-3">
                            <label for="client_info" class="form-label fw-bold">Client</label>
                            <div name="client_info" class="form-control-plaintext border p-2 bg-light">
                                <strong>{{ client.nom_affichage }}</strong>
                                {% if client.adresses %}
                                    <br><small class="text-muted">{{ client.adresses[0].ville }}</small>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Date de commande -->
                        <div class="mb-3">
                            <label for="date_commande" class="form-label fw-bold">Date de commande *</label>
                            <input type="date" class="form-control" id="date_commande" name="date_commande" 
                                   value="{% if commande %}{{ commande.date_commande|date_input }}{% else %}{{ today|date_input }}{% endif %}" required>
                        </div>

                        <!-- Descriptif -->
                        <div class="mb-3">
                            <label for="descriptif" class="form-label fw-bold">Descriptif</label>
                            <textarea class="form-control" id="descriptif" name="descriptif" rows="3" 
                                      placeholder="Description libre de la commande...">{% if commande %}{{ commande.descriptif }}{% endif %}</textarea>
                        </div>

                        <!-- Adresses de facturation et livraison -->
                        <div class="mb-3">
                            {% if client.adresses %}
                                {% set adresse_principale = client.adresses[0] %}
                                {% set adresse_livraison = commande.id_adresse_livraison if commande else adresse_principale.id %}
                                
                                {% if client.adresses|length == 1 or (commande and commande.id_adresse_livraison == adresse_principale.id) %}
                                    <!-- Une seule adresse ou même adresse pour facturation et livraison -->
                                    <label for="id_adresse_{{ adresse_principale.id }}" class="form-label fw-bold">Adresse de Facturation & Livraison</label>
                                    <input type="hidden" name="id_adresse_{{ adresse_principale.id }}" value="{{ adresse_principale.id }}">
                                    <div class="form-control-plaintext border p-2 bg-light">
                                        <strong>Adresse principale</strong><br>
                                        {{ adresse_principale.adresse_l1 }}<br>
                                        {% if adresse_principale.adresse_l2 %}{{ adresse_principale.adresse_l2 }}<br>{% endif %}
                                        {{ adresse_principale.code_postal }} {{ adresse_principale.ville }}
                                    </div>
                                {% else %}
                                    <!-- Adresses différentes pour facturation et livraison -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="adresse_facturation" class="form-label fw-bold">Adresse de Facturation</label>
                                            <div name="adresse_facturation" class="form-control-plaintext border p-2 bg-light">
                                                {{ adresse_principale.adresse_l1 }}<br>
                                                {% if adresse_principale.adresse_l2 %}{{ adresse_principale.adresse_l2 }}<br>{% endif %}
                                                {{ adresse_principale.code_postal }} {{ adresse_principale.ville }}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            {% if client.adresses|length > 1 %}
                                            <label for="nb_adresses" class="form-label fw-bold">Adresse de Livraison</label>
                                            <input type="hidden" name="nb_adresses" value="{{ client.adresses|length }}" title="Nombre d'adresses disponibles">
                                            <input type="hidden" name="id_adresse_facturation" value="{{ adresse_principale.id }}">
                                                {% for adresse in client.adresses %}
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="id_adresse_livraison" id="adresse_{{ adresse.id }}" 
                                                            value="{{ adresse.id }}" {% if adresse.id == adresse_livraison %}checked{% endif %}>
                                                        <label class="form-check-label" for="adresse_{{ adresse.id }}">
                                                            <strong>{{ 'Adresse principale' if adresse.is_principal else 'Autre adresse' }}</strong><br>
                                                            {{ adresse.adresse_l1 }}<br>
                                                            {% if adresse.adresse_l2 %}{{ adresse.adresse_l2 }}<br>{% endif %}
                                                            {{ adresse.code_postal }} {{ adresse.ville }}
                                                        </label>
                                                    </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="form-control-plaintext border p-2 bg-light">
                                                    Identique à l'adresse de facturation
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="text-muted">Aucune adresse renseignée pour ce client</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- État de la commande -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>État de la commande</h5>
                    </div>
                    <div class="card-body">
                        <!-- Montant total (calculé automatiquement) -->
                        <div class="mb-3">
                            <label for="montant" class="form-label fw-bold">Montant total</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="montant" name="montant" 
                                       value="{% if commande and commande.montant %}{{ "%.2f"|format(commande.montant) }}{% else %}0.00{% endif %}" 
                                       step="0.01" readonly>
                                <span class="input-group-text">€</span>
                            </div>
                            <small class="text-muted">Calculé automatiquement selon les produits sélectionnés</small>
                        </div>

                        <!-- Statut de la commande (lecture seule) -->
                        <div class="mb-3">
                            <label for="hidden-status" class="form-label fw-bold">Statut de la commande</label>
                            <input type="hidden" id="hidden-status" name="hidden-status" value=0>
                            {% if not commande %}
                                <!-- Nouvelle commande - en cours par défaut -->
                                <div class="alert alert-info">
                                    <i class="fas fa-clock me-2"></i>
                                    <strong>En cours</strong><br>
                                    <small>Une fois créée, vous pourrez facturer puis expédier cette commande depuis les détails.</small>
                                </div>
                            {% elif commande.is_annulee %}
                                <!-- Commande annulée -->
                                <div class="alert alert-danger">
                                    <i class="fas fa-ban me-2"></i>
                                    <strong>Commande annulée</strong><br>
                                    <small>Cette commande a été annulée et ne peut plus être modifiée.</small>
                                </div>
                            {% elif commande.is_expediee %}
                                <!-- Commande expédiée -->
                                <div class="alert alert-success">
                                    <i class="fas fa-shipping-fast me-2"></i>
                                    <strong>Commande expédiée</strong><br>
                                    <small>Expédiée le {{ commande.date_expedition|strftime if commande.date_expedition else 'Date non renseignée' }}</small>
                                    {% if commande.id_suivi %}
                                        <br><small>Suivi: {{ commande.id_suivi }}</small>
                                    {% endif %}
                                </div>
                            {% elif commande.is_facturee %}
                                <!-- Commande facturée mais pas expédiée -->
                                <div class="alert alert-warning">
                                    <i class="fas fa-file-invoice me-2"></i>
                                    <strong>Commande facturée</strong><br>
                                    <small>Facturée le {{ commande.date_facturation|strftime if commande.date_facturation else 'Date non renseignée' }}</small>
                                </div>
                            {% else %}
                                <!-- Commande en cours -->
                                <div class="alert alert-primary">
                                    <i class="fas fa-clock me-2"></i>
                                    <strong>En cours</strong><br>
                                    <small>Commande en cours de traitement</small>
                                </div>
                            {% endif %}
                            
                            {% if commande and not commande.is_annulee %}
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        La facturation et l'expédition se gèrent depuis la page des détails de la commande.
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section remise client et sélection produits -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Produits de la commande</h5>
                    </div>
                    <div class="card-body">
                        <!-- Remise par défaut du client -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="remise_client" class="form-label fw-bold">Remise par défaut du client</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="remise_client" name="remise_client" 
                                           value="{{ (client.reduces * 100)|round(1) }}" step="0.1" min="0" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                                <small class="text-muted">Cette remise sera appliquée par défaut aux nouveaux produits ajoutés</small>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#selectionProduitsModal">
                                    <i class="fas fa-plus me-1"></i>Ajouter des produits
                                </button>
                            </div>
                        </div>

                        <!-- Tableau des produits sélectionnés -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="tableProduitsSelectionnes">
                                <thead class="table-light">
                                    <tr>
                                        <th >Référence</th>
                                        <th>Désignation</th>
                                        <th>Prix unitaire HT</th>
                                        <th>Quantité</th>
                                        <th>Remise</th>
                                        <th>Total HT</th>
                                        <th id="actionsColumn">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="produitsSelectionnesBody">
                                    {% if commande and lignes_devis %}
                                        {% for ligne in lignes_devis %}
                                        <tr data-produit-id="{{ ligne.produit_id }}" data-ligne-id="{{ ligne.ligne_id }}" 
                                            data-db-id="{{ ligne.devise.id if ligne.devise.id else '' }}"
                                            {% if ligne.is_facture %}data-ligne-facturee="true"{% endif %}>
                                            <td class="reference">{{ ligne.produit.ref_auto }}</td>
                                            <td class="designation">
                                                {{ ligne.produit.des_auto }}
                                                {% if ligne.is_facture %}
                                                    <span class="badge bg-success ms-2">Facturée</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control prix-input" 
                                                           name="prix_{{ ligne.produit_id }}_{{ ligne.ligne_id }}" 
                                                           value="{{ "%.2f"|format(ligne.devise.prix_unitaire) }}" 
                                                           step="0.01" min="0" onchange="calculerTotalLigne(this)"
                                                           title="Prix unitaire HT"
                                                           {% if ligne.is_facture %}readonly{% endif %}>
                                                    <span class="input-group-text">€</span>
                                                </div>
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm qte-input" 
                                                       name="qte_{{ ligne.produit_id }}_{{ ligne.ligne_id }}" 
                                                       value="{{ ligne.devise.qte }}" 
                                                       min="1" onchange="calculerTotalLigne(this)"
                                                       title="Quantité"
                                                       {% if ligne.is_facture %}readonly{% endif %}>
                                            </td>
                                            <td>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control remise-input" 
                                                           name="remise_{{ ligne.produit_id }}_{{ ligne.ligne_id }}" 
                                                           value="{{ ((ligne.devise.remise or 0) * 100)|round(1) }}" 
                                                           step="0.1" min="0" max="100" onchange="calculerTotalLigne(this)"
                                                           title="Remise en pourcentage"
                                                           {% if ligne.is_facture %}readonly{% endif %}>
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </td>
                                            <td class="total-ligne fw-bold">
                                                {{ "%.2f"|format(ligne.total_ligne) }} €
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="duppliquerLigne(this)" title="Dupliquer">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                                {% if not ligne.is_facture %}
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="supprimerLigne(this)" title="Supprimer">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                {% else %}
                                                <button type="button" class="btn btn-sm btn-outline-secondary" disabled title="Ligne facturée, suppression impossible">
                                                    <i class="fas fa-lock"></i>
                                                </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="5" class="text-end fw-bold">Total de la commande :</td>
                                        <td class="fw-bold" id="totalCommande">
                                            {% if commande and commande.montant %}{{ "%.2f"|format(commande.montant) }} €{% else %}0.00 €{% endif %}
                                        </td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                            
                            <div id="aucunProduitMessage" class="text-center text-muted py-4" {% if commande and lignes_devis %}style="display: none;"{% endif %}>
                                <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                                <h5>Aucun produit sélectionné</h5>
                                <p>Cliquez sur "Ajouter des produits" pour commencer votre commande.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Boutons d'action -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('clients.get_client', id_client=client.id) }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Annuler
                    </a>
                    <button type="submit" name="action" value="save" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>
                        {% if form_sub_context == 'create' %}Créer la commande{% else %}Mettre à jour{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modal de sélection des produits -->
<div class="modal fade" id="selectionProduitsModal" tabindex="-1" aria-labelledby="selectionProduitsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectionProduitsModalLabel">
                    <i class="fas fa-search me-2"></i>Sélectionner des produits
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Barre de recherche -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="rechercheProductsInput" 
                                   placeholder="Rechercher par référence ou désignation..." 
                                   onkeyup="filtrerProduitsCatalogue()">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-secondary" onclick="reinitialiserRecherche()">
                            <i class="fas fa-times me-1"></i>Effacer la recherche
                        </button>
                    </div>
                </div>
                
                <!-- Filtres -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="modalFilterMillesime" class="form-label">Millésime</label>
                        <select class="form-select" id="modalFilterMillesime" onchange="filtrerProduitsCatalogue()">
                            <option value="">Tous</option>
                            {% for millesime in millesimes %}
                            <option value="{{ millesime }}" {% if millesime == current_year %}selected{% endif %}>{{ millesime }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="modalFilterType" class="form-label">Type</label>
                        <select class="form-select" id="modalFilterType" onchange="filtrerProduitsCatalogue()">
                            <option value="">Tous</option>
                            {% for type_produit in types_produit %}
                            <option value="{{ type_produit }}" {% if type_produit == 'Courrier' %}selected{% endif %}>{{ type_produit }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="modalFilterGeographie" class="form-label">Géographie</label>
                        <select class="form-select" id="modalFilterGeographie" onchange="filtrerProduitsCatalogue()">
                            <option value="">Toutes</option>
                            {% for geographie in geographies %}
                            <option value="{{ geographie }}" {% if geographie == 'FRANCE' %}selected{% endif %}>{{ geographie }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="button" class="btn btn-outline-secondary w-100" onclick="reinitialiserFiltresModal()">
                            <i class="fas fa-eraser me-1"></i>Reset filtres
                        </button>
                    </div>
                </div>
                
                <!-- Tableau des produits du catalogue -->
                <div id="modalCatalogueProducts" class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th id="selectAllLinesHeader">Sélection</th>
                                <th>Référence</th>
                                <th>Désignation</th>
                                <th>Type</th>
                                <th>Millésime</th>
                                <th>Géographie</th>
                                <th>Prix HT</th>
                                <th id="qteColumn">Qté</th>
                            </tr>
                        </thead>
                        <tbody id="modalCatalogueBody">
                            {% for produit in catalogue_complet %}
                            <tr class="modal-catalogue-row" 
                                data-millesime="{{ produit.millesime }}" 
                                data-type="{{ produit.type_produit }}" 
                                data-geographie="{{ produit.geographie }}"
                                data-reference="{{ produit.ref_auto|lower }}"
                                data-designation="{{ produit.des_auto|lower }}">
                                <td>
                                    <input type="checkbox" class="form-check-input modal-product-checkbox" 
                                           value="{{ produit.id }}" data-produit-id="{{ produit.id }}">
                                </td>
                                <td>{{ produit.ref_auto }}</td>
                                <td>{{ produit.des_auto }}</td>
                                <td>{{ produit.type_produit }}</td>
                                <td>{{ produit.millesime }}</td>
                                <td>{{ produit.geographie }}</td>
                                <td>{{ "%.2f"|format(produit.prix_unitaire_ht) }} €</td>
                                <td>
                                    <input type="number" class="form-control form-control-sm modal-qte-input" 
                                           id="modalQte_{{ produit.id }}" value="1" min="1">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div id="modalAucunProduitMessage" class="text-center text-muted py-4">
                    <i class="fas fa-search fa-2x mb-2"></i>
                    <h5>Aucun produit trouvé</h5>
                    <p>Aucun produit ne correspond à vos critères de recherche.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="ajouterProduitsSelectionnes()">
                    <i class="fas fa-plus me-1"></i>Ajouter les produits sélectionnés
                </button>
            </div>
        </div>
    </div>
</div>
