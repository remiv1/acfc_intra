name: üìä G√©n√©ration Automatique de Rapport de Suivi

on:
  # D√©clenchement manuel
  workflow_dispatch:
    inputs:
      days:
        description: 'Nombre de jours √† analyser'
        required: false
        default: '7'
        type: string
      
  # D√©clenchement automatique chaque dimanche √† 20h
  schedule:
    - cron: '0 20 * * 0'  # Dimanche 20h UTC
  
  # D√©clenchement sur push vers main ou sprint branches
  push:
    branches: [ main, sprint_* ]
    paths-ignore:
      - 'suivi_realisation*.md'
      - '.github/**'

jobs:
  generate-report:
    name: üîÑ G√©n√©ration du rapport
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: üì• Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # R√©cup√®re tout l'historique Git
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: üêç Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: üìä G√©n√©ration du rapport
      id: generate
      run: |
        # D√©finir le nombre de jours
        DAYS="${{ github.event.inputs.days || '7' }}"
        echo "Analyse des $DAYS derniers jours"
        
        # Ex√©cuter le script
        python scripts/generate_progress_report.py \
          --days "$DAYS" \
          --output "suivi_realisation_auto.md" \
          --repo "."
        
        # V√©rifier si le fichier a √©t√© cr√©√©/modifi√©
        if [ -f "suivi_realisation_auto.md" ]; then
          echo "report_generated=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Rapport g√©n√©r√© avec succ√®s"
        else
          echo "report_generated=false" >> $GITHUB_OUTPUT
          echo "‚ùå √âchec de la g√©n√©ration du rapport"
        fi
    
    - name: üìù Configuration Git
      if: steps.generate.outputs.report_generated == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - Progress Report"
    
    - name: üíæ Commit et push du rapport
      if: steps.generate.outputs.report_generated == 'true'
      run: |
        # Ajouter le fichier
        git add suivi_realisation_auto.md
        
        # V√©rifier s'il y a des changements
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è Aucune modification d√©tect√©e dans le rapport"
        else
          # Cr√©er le commit
          COMMIT_MSG="üìä Mise √† jour automatique du rapport de suivi ($(date '+%d/%m/%Y'))"
          git commit -m "$COMMIT_MSG"
          
          # Pousser les changements
          git push
          
          echo "‚úÖ Rapport mis √† jour et pouss√© vers le d√©p√¥t"
        fi
    
    - name: üìã R√©sum√© des m√©triques
      if: steps.generate.outputs.report_generated == 'true'
      run: |
        echo "## üìä R√©sum√© du Rapport G√©n√©r√©" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**üìÖ Date de g√©n√©ration :** $(date '+%d/%m/%Y √† %H:%M')" >> $GITHUB_STEP_SUMMARY
        echo "**üìä P√©riode analys√©e :** ${{ github.event.inputs.days || '7' }} derniers jours" >> $GITHUB_STEP_SUMMARY
        echo "**üåø Branche :** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Extraire quelques m√©triques du rapport g√©n√©r√©
        if [ -f "suivi_realisation_auto.md" ]; then
          COMMITS=$(grep -o "Nombre de commits.*[0-9]" suivi_realisation_auto.md | head -1 || echo "Non disponible")
          LIGNES=$(grep -o "[0-9]* lignes ajout√©es" suivi_realisation_auto.md | head -1 || echo "Non disponible")
          
          echo "**üìà M√©triques cl√©s :**" >> $GITHUB_STEP_SUMMARY
          echo "- $COMMITS" >> $GITHUB_STEP_SUMMARY
          echo "- $LIGNES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÑ Fichier g√©n√©r√© : \`suivi_realisation_auto.md\`" >> $GITHUB_STEP_SUMMARY
        fi

  notify-completion:
    name: üîî Notification de fin
    needs: generate-report
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: üì¢ Statut du workflow
      run: |
        if [ "${{ needs.generate-report.result }}" == "success" ]; then
          echo "‚úÖ Workflow termin√© avec succ√®s"
          echo "Le rapport de suivi a √©t√© g√©n√©r√© et mis √† jour automatiquement."
        else
          echo "‚ùå √âchec du workflow"
          echo "La g√©n√©ration du rapport de suivi a √©chou√©. V√©rifiez les logs."
          exit 1
        fi
